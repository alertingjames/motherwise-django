<html>
<head>

<title>MotherWise Nest | Chat</title>
{% load static %}
{% load tag_library %}
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
<link href='https://fonts.googleapis.com/css?family=Satisfy' rel="stylesheet" type="text/css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<link rel="stylesheet" type="text/css" href="/static/style.css"/>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.1/css/all.css">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="shortcut icon" href="/static/images/icon.png" type="image/jpg">

<link href="/static/images/icons/apple-touch-icon.png" rel="apple-touch-icon" />
<link href="/static/images/icons/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152" />
<link href="/static/images/icons/apple-touch-icon-167x167.png" rel="apple-touch-icon" sizes="167x167" />
<link href="/static/images/icons/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180" />
<link href="/static/images/icons/icon-hires.png" rel="icon" sizes="192x192" />
<link href="/static/images/icons/icon-normal.png" rel="icon" sizes="128x128" />

<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/static/css/v1/chat.css">

<!--<script src='https://meet.jit.si/external_api.js'></script>-->

</head>

<body>

<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"></script>
<script>
WebFont.load({
    google: {
        families: ["Lato:100,300,400,700,900","Karla:regular","Cookie:regular"]
    }
});
document.addEventListener("visibilitychange", event => {
    if (document.visibilityState == "visible") {
        console.log("tab is active")
        firebase.database().ref('status/' + friend_email + '_' + sender_email).remove();
        firebase.database().ref('status/' + friend_email + '_' + sender_email).push().set({
            user: sender_email,
            time: new Date().getTime(),
            online: 'online'
        });
    } else {
        console.log("tab is inactive")
        firebase.database().ref('status/' + friend_email + '_' + sender_email).remove();
        firebase.database().ref('status/' + friend_email + '_' + sender_email).push().set({
            user: sender_email,
            time: new Date().getTime(),
            online: 'offline'
        });
    }
});
</script>

<div id="imageFrame">
	<img src="" id="image_message">
    <video id="videoresult" autobuffer  controls width="250" autoplay loop style="display:none;">
        <source src="" id="videohere"/>
    </video>
    <br>
    <span class="fa fa-times" onclick="javascript:cancelMedia()"></span>
    <span class="fa fa-check" style="color:red; margin-left:30px;" onclick="javascript:okay();"></span>
</div>

<script>
    function cancelMedia() {
        document.getElementById('imageFrame').style.display='none';
        document.getElementById('picture').value = "";
        document.getElementById('videofile').value = "";
    }
</script>

<div id="photo">
    <img src="{% if friend.photo_url %}{{friend.photo_url}}{% elif friend.cohort == 'admin' %}/static/images/manager.jpg{% else %}/static/images/ic_profile.png{% endif %}">
    <div id="st"></div>
</div>

<img src="/static/images/processing.gif" id="gif">

<img src="/static/images/logo.png" class="logo">

<div id="title">
    {% if friend %}<i class="fa fa-comments-o"></i>{{friend.name}}{% endif %}
</div>

<div class="main">
    <div class="header">
        <i id="back" class="fa fa-chevron-left" onclick="if(window.history.length > 1) { history.back(); } else { window.close(); }"></i>
        <i id="home" class="fa fa-home" onclick="window.location.href='/mothers/zzzzz/';"></i>
    </div>
    <div class="container-fluid main-body">
      <div class="row">
        <div class="col-sm-3" style="text-align:center;">

            <div style="width:100%; margin:10px 0px 10px 0px; text-align:center;">
                <div style="color:white;font-size:18px;font-family:verdana;text-align:left;">
                    Chat with Group
                </div>
                <div style="display:flex; margin-top:10px;">
                    <select name="cohort" required id="cohort" style="flex-grow:1;font-size:16px;appearance:none;" onchange="setValue(this)">
                        <!--<option value="">Please choose a group</option>-->
                        {% for c in cohorts %}
                        <option value="{{c}}" {% if c == me.cohort %}selected{% else %}disabled style="color:rgba(0,0,0,0.1);"{% endif %}>{{c}}</option>
                        {% endfor %}
                    </select>
                    <input hidden id="selected_cohort" value="{{me.cohort}}">
                    <script>
                        function setValue(obj){
                            var value = obj.value;
                            if(value.length > 0){
                                document.getElementById('selected_cohort').value = value;
                                document.getElementById('cohort_chat_button').style.display = "block";
                            }else{
                                document.getElementById('cohort_chat_button').style.display = "none";
                            }
                        }
                        function to_cohort_chat(){
                            var cht = document.getElementById('selected_cohort').value;
                            if(cht.length == 0) return;
                            window.location.href = "/mothers/switch_cohort_chat?cohort=" + cht;
                        }
                    </script>

                    <a href="javascript:void(0)" onclick="javascript:to_cohort_chat();">
                        <div style="display:{% if me.cohort %}block;{% else %}none;{% endif %}" id="cohort_chat_button">
                            <i class="fa fa-long-arrow-right"></i>
                        </div>
                    </a>

        		</div>
            </div>

            <div class="contactors-section">
                <a href="javascript:void(0);" onclick="javascript:toggleContactForm();">
                    Chat with Recent Contacts
                    <span class="fa fa-caret-down" style="color:white; margin-left:20px;" id="arrow"></span>
                </a>

                <script>
                    var showF = false;
                    var ii = 0;
                    function toggleContactForm(){
                        ii++;
                        if(showF == true){
                            showF = false;
                            document.getElementById('contactform').style.display='none';
                            $('#arrow').removeClass('fa fa-caret-up').addClass('fa fa-caret-down');
                        }else{
                            showF = true;
                            document.getElementById('contactform').style.display='block';
                            if(ii > 1) $('#arrow').removeClass('fa fa-caret-down').addClass('fa fa-caret-up');
                            else $('#arrow').addClass('fa fa-caret-up');
                        }
                    }
                </script>

                <div id="contactform" style="display:none;">
                    {% if contacts %}
                        <div style="width:100%;height:auto;margin-top:10px;float:left;overflow:auto;" id="clist">
                            {% for member in contacts %}
                            <div class="contact-form">
                                <input type="hidden" id="c_email" value="{{member.email}}">
                                <div class="contentform">
                                    <div style="width:100%; padding-bottom:3px; display:flex;" >
                                        <div style="padding:10px; float:left; position:relative;">
                                            <a href="{% if member.photo_url %}{{member.photo_url}}{% endif %}">
                                                <img src="{% if member.photo_url %}{{member.photo_url}}{% elif member.cohort == 'admin' %}/static/images/manager.jpg{% else %}/static/images/ic_profile.png{% endif %}"
                                                    style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                                            </a>
                                            <span class="fas fa-comment-alt" style="color:red; bottom:5px; position:absolute; right:2px; font-size:15px; display:none;" id="cbadge"></span>
                                        </div>
                                        <a href="/mothers/switch_chat?member_id={{member.pk}}" style="flex-grow:1;">
                                            <div class="name-section">
                                                {{member.name}}
                                                {% if member.cohort == 'admin' %}
                                                    <div style="font-size:12px;color:yellow;">Manager</div>
                                                {% else %}
                                                    <div style="font-size:12px;">{{member.cohort}}</div>
                                                {% endif %}
                                            </div>
                                        </a>
                                        <a href="/mothers/switch_chat?member_id={{member.pk}}" style="background-color:transparent;margin-right:20px;">
                                            <span class="fa fa-comment-o" aria-hidden="true" style="color:white; font-size:18px;"></span>
                                        </a>
                                        <a href="/mothers/delcontact?member_id={{member.pk}}" style="background-color:transparent; margin-right:5px;">
                                            <span class="fa fa-trash" aria-hidden="true" style="color:white;font-size:18px;"
                                                onclick="return confirm('Are you sure you want to remove this contact?')"></span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}

                        </div>

                    {%else %}
                            <center>
                                <br>
                                <br>
                                <h4 class="my_items col-sm-offset-1" style="color:rgba(255,255,255,0.7); margin: 30px;">No any contact ...</h4>
                            </center>

                    {% endif %}

                </div>

            </div>

        </div>

        <div class="col-sm-6">

            <div style="width:100%; display:inline-block;">

                <!--////////////////////////////////-->

                <div id="chat-form">
                    <div style="width:100%; height:auto; margin-left:5px;">
                        <img src="{% if friend.photo_url %}{{friend.photo_url}}{% elif friend.cohort == 'admin' %}/static/images/manager.jpg{% else %}/static/images/ic_profile.png{% endif %}"
                            style="width:50px; height:50px; border-radius:50%; object-fit:cover; float:left;">
                        <div style="color:white; float:left; display:inline-block; padding: 8px 0px; 0px 0px; margin-left:15px;">
                            <div style="font-size:18px; font-weight:500;">{{friend.name}}</div>
                            <div id="online" style="margin-top:2px; font-size:12px;"></div>
                        </div>
                        <a href="javascript:void(0)" onclick="openMeet();" class="vmeet">
                            <span class="fa fa-video"></span>
                        </a>
                    </div>
                    <br>
                    <br>
                    <br>
                    <div class="chat-contentform">
                        <div class="chat-formcontent">
                            <div id="chat_log">
                                <div id="list" aria-placeholder="No message ..."></div>
                            </div>
                            <div id="send-form" style="width:101%; margin-bottom: 15%; margin-top:5px;">
                                <input type="hidden" id="sender_name" value="{{me.name}}">
                                <input type="hidden" id="sender_id" value="{{me.pk}}">
                                <input type="hidden" id="sender_email" value="{{me.email}}">
                                <input type="hidden" id="sender_photo" value="{{me.photo_url}}">
                                <input type="hidden" id="friend_name" value="{{friend.name}}">
                                <!--<input type="hidden" id="user_id" value="{{user.id}}">-->
                                <input type="hidden" id="friend_email" value="{{friend.email}}">
                                <input type="hidden" id="type" value="{{friend.email}}">
                                <input type="hidden" id="lat" value="{% if lat %}{{lat}}{% else %}{% endif %}">
                                <input type="hidden" id="lng" value="{% if lng %}{{lng}}{% else %}{% endif %}">
                                <div style="width:99%; margin-bottom:5px; display:none;" id="panel">
                                    <table  style="width:100%;">
                                        <tr style="background:white;">
                                            <td class="attach-button">
                                                <label class="button" id="picture-btn" style="background:transparent; border:0;"><i class="fa fa-image" style="font-size:19px;"></i>
                                                    <input type="file" name="photo" value="http://lorempixel.com/100/100/people/9" id="picture" accept="image/*"/>
                                                </label>
                                            </td>
                                            <script>
                                                function readFile() {

            			                            if (this.files && this.files[0]) {

            					                        var FR= new FileReader();

            					                        FR.addEventListener("load", function(e) {
            					                            document.getElementById("imageFrame").style.display = "block";
            					                            document.getElementById("image_message").style.display = "block";
            					                            document.getElementById("videoresult").style.display = "none";
             							                    document.getElementById("image_message").src       = e.target.result;
                                                            document.getElementById("type").value = 'picture';
                                                            show_panel();
            					                        });

            					                        FR.readAsDataURL( this.files[0] );

            					                        file = this.files[0];

            			                            }

                                                }

                                                document.getElementById("picture").addEventListener("change", readFile);
                                            </script>

                                            <td class="attach-button">
                                                <label class="button" id="video-btn" style="background:transparent; border:0;"><i class="fa fa-video-camera" style="font-size:19px;"></i>
                                                    <input type="file" name="video" value="http://lorempixel.com/100/100/people/9" id="videofile" accept="video/*" style="display:none;"/>
                                                </label>
                                            </td>
                                            <script>
                                                var file;
                                                $(document).on("change", "#videofile", function(evt) {
                                                    var $source = $('#videohere');
                                                    $source[0].src = URL.createObjectURL(this.files[0]);
                                                    $source.parent()[0].load();
                                                    file = this.files[0];
                                                    document.getElementById("imageFrame").style.display = "block";
            					                    document.getElementById("image_message").style.display = "none";
            					                    document.getElementById("videoresult").style.display = "block";
            					                    document.getElementById("type").value = 'video';
            					                    show_panel();
                                                });
            				                </script>

            				                <td class="attach-button">
            				                    <label class="button" id="file-btn" style="background:transparent;border:0;"><i class="fa fa-file" style="font-size:17px;"></i>
                                                    <input type="file" name="allfile" value="http://lorempixel.com/100/100/people/9" id="allfile" style="display:none;"/>
                                                </label>
            				                </td>

                                        </tr>
                                        <tr style="display:none;">
                                            <td class="attach-button"><label class="button" id="location-btn" onclick="chat_map()"><i class="fa fa-location-arrow"></i>Location</label></td>
                                            <td class="attach-button">
                                                                        <!--onclick="open_panel()"-->
                                                <label class="button" id="audio-btn" onclick="open_panel()"><i class="fa fa-volume-up"></i>Audio
                                                    <!--<input type="file" style="display:none;" accept="audio/*" id="audio">-->
                                                </label>
                                            </td>
                                            <!--<script>-->
                                                <!--var file3;-->
                                                <!--$(document).on("change", "#audio", function(evt) {-->
                                                    <!--file3 = this.files[0];-->
            					                    <!--document.getElementById("type").value = 'file';-->
            					                    <!--uploadFile(file3);-->
                                                <!--});-->
            				                <!--</script>-->
                                        </tr>
                                    </table>
                                    <center>
                                        <div id="audio-panel" style="display:none;">
                                            <audio controls autoplay></audio>
                		                    <script type="text/javascript" src="/static/js/recorder.js"> </script>
                                            <fieldset style="margin:10px; border:2px solid white;">
                                                <legend style="color:white; font-size:18px; font-weight:600;">RECORD AUDIO</legend>
                		                        <input onclick="javascript:startRecording();" type="button" value="start recording" style="border-radius:8px; background:#86592d; color:white; padding:6px 15px;"/>
                		                        <input onclick="javascript:stopRecording();" type="button" value="stop recording" style="border-radius:8px; background:#86592d; color:white; padding:6px 15px;"/>
                                            </fieldset>
                                        </div>

                                        <!--<label class="button" id="file-btn" style="width:99%; height:42px;"><i class="fa fa-folder-open"></i>All Files-->
                                        <!--        <input type="file" name="allfile" value="http://lorempixel.com/100/100/people/9" id="allfile" style="display:none;"/></label>-->
                                    </center>
                                            <script>
                                                var file2;
                                                $(document).on("change", "#allfile", function(evt) {
                                                    file2 = this.files[0];
            					                    document.getElementById("type").value = 'file';
            					                    uploadFile(file2);
            					                    show_panel();
                                                });
            				                </script>
                                </div>
                                <div class="chat-footer">
                                    <input type="text" required id="message" placeholder="Write something here..." oninput="myFunction()">
                                    <button type="button" id="attachment-btn" class="chat-btn" onclick="show_panel()"><i class="fa fa-paperclip"></i></button>
                                    <button type="button" id="emoji-btn" class="chat-btn"><i class="fa fa-smile-o"></i></button>
                                    <button type="submit" class="chat-btn send" id="submitBtn" onclick="submitClick()"><i class="fa fa-send"></i></button>
                                </div>

                                <script>
                                    var inputBox = document.getElementById("message");
                                    inputBox.addEventListener("keyup", function(event) {
                                      if (event.keyCode === 13) {
                                          event.preventDefault();
                                          document.getElementById("submitBtn").click();
                                      }
                                    });
                                </script>

                                <script src="/static/emoji1/fgEmojiPicker.js"></script>
                                <script>
                                    const emojiPicker = new FgEmojiPicker({
                                        trigger: ['#emoji-btn'],
                                        position: ['top', 'left'],
                                        preFetch: true,
                                        insertInto: document.querySelector('input#message'),
                                        emit(obj, triggerElement) {
                                            document.getElementById("submitBtn").style.display = "block";
                                            document.getElementById("attachment-btn").style.display = "none";
                                        }
                                    });
                                </script>

                            </div>
                        </div>
                    </div>
                </div>

                <!--//////////////////////////////////-->

            </div>
        </div>

        <div class="col-sm-3" id="member-list">

            <div style="width:100%; margin:10px; position:relative;">
                <div style="color:white; font-size:18px; font-family:verdana;">
                    Chat with Members
                </div>
                <span class="fas fa-comment-alt" aria-hidden="true" style="position:absolute; left:220px; top:0px; color:red; font-size:20px; display:none;" id="chatnotibadge"></span>
            </div>

            {% if members %}
                <div id="mlist">
                    {% for member in members %}
                    <div class="user-form">
                        <input type="hidden" id="member_email" value="{{member.email}}">
                        <div class="contentform">
                            <div style="width:100%; padding-bottom:3px; display:flex;" >
                                <div style="padding:10px; float:left; position:relative;">
                                    <a href="{% if member.photo_url %}{{member.photo_url}}{% endif %}">
                                        <img src="{% if member.photo_url %}{{member.photo_url}}{% elif member.cohort == 'admin' %}/static/images/manager.jpg{% else %}/static/images/ic_profile.png{% endif %}"
                                            style="width:40px; border-radius:50%; height:40px; object-fit:cover;">
                                    </a>
                                    <span class="fas fa-comment-alt" style="color:red; bottom:5px; position:absolute; right:2px; font-size:16px; display:none;" id="badge"></span>
                                </div>
                                <a href="/mothers/switch_chat?member_id={{member.pk}}" style="flex-grow:1;">
                                    <div class="name-section">
                                        {{member.name}}
                                        {% if member.cohort == 'admin' %}
                                            <div style="font-size:12px; color:yellow;">Manager</div>
                                        {% else %}
                                            <div style="font-size:12px;">{{member.cohort}}</div>
                                        {% endif %}
                                    </div>
                                </a>
                                <div style="float:right; margin-top:5px;">
                                    <a href="javascript:void(0)" style="background-color:transparent;display:none;" onclick="javascript:window.location.assign('mailto:{{member.email}}');">
                                        <span class="far fa-comment-alt" aria-hidden="true" style="color:white;font-size:18px;"></span>
                                    </a>
                                </div>
                                <div style="float:right;">
                                    <a href="/mothers/switch_chat?member_id={{member.pk}}" style="background-color:transparent;">
                                        <span class="fa fa-comments-o" aria-hidden="true" style="color:white;font-size:20px;margin-right:5px;"></span>
                                    </a>
                                </div>
                            </div>

                        </div>

                    </div>

                    {% endfor %}
                </div>
            {%else %}
                    <center>
                        <br>
                        <br>
                        <h4 class="my_items col-sm-offset-1" style="color:rgba(255,255,255,0.7); margin: 30px;">No member loaded ...</h4>
                    </center>

            {% endif %}

        </div>

    </div>
</div>
</div>

<div id="meet" style="position:fixed; left:50%; float:middle; transform:translate(-50%, -50%); min-width:400px; max-width:700px; width:auto; z-index:200; top:50%; display:none;">
    <input style="height:1px; opacity:0;">
</div>

<script>
    // function openMeet(){
    //     document.getElementById('meet').style.display = 'block';
    //     document.getElementById('backgroundOverlay').style.display='block';
    // }

    // function dismissLayouts(){
    //     document.getElementById('meet').style.display = 'none';
    //     document.getElementById('backgroundOverlay').style.display='none';
    // }

    // var roomID = '{{me.pk}}_{{friend.pk}}';
    // if (Number('{{me.pk}}') > Number('{{friend.pk}}')){
    //     roomID = '{{friend.pk}}_{{me.pk}}';
    // }

    // console.log(roomID);

    // var myId = '{{me.pk}}_{{me.pk}}';
    // const domain = 'meet.jit.si';
    // var height = 700;
    // const options = {
    //     roomName: roomID,
    //     // width: 700,
    //     height: height,
    //     parentNode: document.querySelector('#meet'),
    //     interfaceConfigOverwrite: {
    //         // TILE_VIEW_MAX_COLUMNS: 4,
    //         HIDE_INVITE_MORE_HEADER: true
    //     },
    //     userInfo: {
    //         participantId: myId,
    //         // email: 'email@jitsiexamplemail.com',
    //         displayName: '{{me.name}}'
    //     }
    // };
    // const api = new JitsiMeetExternalAPI(domain, options);
    // api.executeCommand('avatarUrl', '{{me.photo_url}}');

    // api.executeCommand('setVideoQuality', 1024);

</script>

<div id="backgroundOverlay" onclick="javascript:dismissLayouts();">
</div>

<input type="hidden" id="me_email" value="{{me.email}}">

<meta charset="UTF-8">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">

<button onclick="topFunction()" id="upBtn" title="Go to top"><i class="glyphicon glyphicon-menu-up" style="color:white; font-size:14px;"></i></button>

<div style="display:inline-block; height:0px; width:auto; position:fixed; z-index:100; bottom:50px; border-radius:30px; left:1%;">
    <div id="google_translate_element" style="float:left;"></div>
</div>
<script type="text/javascript">
    function googleTranslateElementInit() {
        new google.translate.TranslateElement({pageLanguage: 'en'}, 'google_translate_element');
    }
</script>
<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script>
// When the user scrolls down 20px from the top of the document, show the button
window.onscroll = function() {scrollFunction()};

function scrollFunction() {
    if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20 || document.getElementById("mlist").scrollTop > 20) {
        document.getElementById("upBtn").style.display = "block";                         // Top button display none;
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200){
            document.getElementById("photo").style.display = "block";
        }else document.getElementById("photo").style.display = "none";
    } else {
        document.getElementById("upBtn").style.display = "none";
        document.getElementById("photo").style.display = "none";
    }

    if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
        document.getElementById("photo").style.display = "block";
    } else {
        document.getElementById("photo").style.display = "none";
    }
}

// When the user clicks on the button, scroll to the top of the document
function topFunction() {
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
    document.getElementById("member-list").scrollTop = 0;
}

</script>


<script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDveaXbV1HHMREyZzbvQe53BJEHVIRCf14",
    authDomain: "motherwise-1585202524394.firebaseapp.com",
    databaseURL: "https://motherwise-1585202524394.firebaseio.com",
    projectId: "motherwise-1585202524394",
    storageBucket: "motherwise-1585202524394.appspot.com",
  };
  firebase.initializeApp(config);
</script>
<!--<script src="/static/js/chat/memb_chat.js"></script>-->

<script>

    var flag = false;
    var aflag = false;
    function show_panel(){
        if (flag){
            flag = false; document.getElementById("panel").style.display = "none";
            document.getElementById("attachment-btn").innerHTML = '<i class="fa fa-paperclip"></i>';
            document.getElementById("audio-panel").style.display = "none";
        }else {
            flag = true; document.getElementById("panel").style.display = "block";
            document.getElementById("attachment-btn").innerHTML = '<i class="fa fa-times-thin fa-2x" style="margin-top:-8px;" aria-hidden="true"></i>';
            // document.body.scrollTop = 1000;
            // document.documentElement.scrollTop = 1000;
        }
    }

    function open_panel(){
        if (aflag){
            aflag = false;
            document.getElementById("audio-panel").style.display = "none";
        }else {
            aflag = true;
            document.getElementById("audio-panel").style.display = "block";
            document.body.scrollTop = 1000;
            document.documentElement.scrollTop = 1000;
        }
    }

    function chat_map(){
        window.location.href = "/map_chat";
    }

    if (document.getElementById("lat").value.length > 0 && document.getElementById("lng").value.length > 0){

        document.getElementById("imageFrame").style.display = "block";
	    document.getElementById("image_message").style.display = "block";
	    document.getElementById("videoresult").style.display = "none";
 	    document.getElementById("image_message").src = "/static/images/mapimage.jpg";
 	    document.getElementById("type").value = 'map';
    }

</script>

<script>

 window.URL = window.URL || window.webkitURL;
 navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;

 var recorder;
 var audio = document.querySelector('audio');

 function startRecording() {
//  window.location.href = "/recorder";
  if (navigator.getUserMedia) {
   navigator.getUserMedia({audio: true}, onSuccess, onFail);
  } else {
   console.log('navigator.getUserMedia not present');
  }
 }

 function stopRecording() {
  recorder.stop();
  recorder.exportWAV(function(s) {
    audio.src = window.URL.createObjectURL(s);
    audio.play(); //call this to play the song right away
    uploadAudio(audio.src);
  });
 }

 var onFail = function(e) {
  console.log('Rejected!', e);
 };

 var onSuccess = function(s) {
  var context = new webkitAudioContext();
  var mediaStreamSource = context.createMediaStreamSource(s);
  recorder = new Recorder(mediaStreamSource);
  recorder.record();

  // audio loopback
  // mediaStreamSource.connect(context.destination);
 }

 function uploadAudio(url){
  fetch(url)
  .then(res => res.blob()) // Gets the response and returns it as a blob
  .then(blob => {
    // Here's where you get access to the blob
    // And you can use it for whatever you want
    // Like calling ref().put(blob)

    // Here, I use it to make an image appear on the page
    document.getElementById("type").value = 'audio';
    uploadFile(blob);
  });
 }

</script>

<script>

var list = document.getElementById("mlist");
var lis = list.querySelectorAll( "#mlist > div" );
var prods = [];
for(var i=0; i<lis.length; i++){
    prods.push(lis[i]);
}

console.log(prods.length);

var me_email = document.getElementById("me_email").value;
// var ul = document.getElementById("list");
// var keys = [];
me_email = me_email.replace(/\./g,"ddoott");
var starCountRef = firebase.database().ref('notification/' + me_email);
starCountRef.on('child_added', function(snapshot) {
  var key = snapshot.val();
  if (key){
    var key2 = getChildObj(key);
    var sender_email = key2.sender
    if(sender_email.length > 0){
        for(var i=0; i<prods.length; i++){
            var emailBox = prods[i].querySelector("input[id='member_email']");
            var badge = prods[i].querySelector("span[id='badge']");
            if(emailBox.value == sender_email){
                if(i > 0) {
                    badge.style.display = "block";
                    document.getElementById("chatnotibadge").style.display = 'block';
                }else{
                    starCountRef.child(sender_email.replace(/\./g,"ddoott")).remove();
                }
            }else{
                badge.style.display = "none";
            }
        }
    }
  }
});

function getChildObj (obj) {
    var obj2;
    for (var p in obj) {
        if (obj.hasOwnProperty(p)) {
            obj2 = obj[p];
        }
    }
    return obj2;
}


var clist = document.getElementById("clist");
var clis = clist.querySelectorAll( "#clist > div" );
var cprods = [];
for(var i=0; i<clis.length; i++){
    cprods.push(clis[i]);
}


starCountRef.on('child_added', function(snapshot) {
  var key = snapshot.val();
  if (key){
    var key2 = getChildObj(key);
    var sender_email = key2.sender
    if(sender_email.length > 0){
        for(var i=0; i<cprods.length; i++){
            var emailBox = cprods[i].querySelector("input[id='c_email']");
            var badge = cprods[i].querySelector("span[id='cbadge']");
            if(emailBox.value == sender_email){
                if(i > 0) {
                    badge.style.display = "block";
                    document.getElementById("chatnotibadge").style.display = 'block';
                }else{
                    starCountRef.child(sender_email.replace(/\./g,"ddoott")).remove();
                }
            }else{
                badge.style.display = "none";
            }
        }
    }
  }
});


</script>


<script>

var sender_id = document.getElementById("sender_id").value;
//var user_id = document.getElementById("user_id").value;
var sender_name = document.getElementById("sender_name").value;
var sender_email = document.getElementById("sender_email").value;
var sender_photo = document.getElementById("sender_photo").value;
var friend_name = document.getElementById("friend_name").value;
var friend_email = document.getElementById("friend_email").value;
var message = document.getElementById("message");
var submitBtn = document.getElementById("submitBtn");
var chat_log = document.getElementById("chat_log");
var online = document.getElementById("online");
var st = document.getElementById("st");

var attachBtn = document.getElementById("attachment-btn");

var semail = sender_email;
var femail = friend_email;

sender_email = sender_email.replace(/\./g,"ddoott");
friend_email = friend_email.replace(/\./g,"ddoott");

// console.log('notification/' + sender_email + '/' + friend_email);
// console.log(friend_email.replace(/ddoott/g,"."));

firebase.database().ref('notification/' + sender_email + '/' + friend_email).remove();

firebase.database().ref('status/' + friend_email + '_' + sender_email).remove();
firebase.database().ref('status/' + friend_email + '_' + sender_email).push().set({
    user: sender_email,
    time: new Date().getTime(),
    online: 'online'
});

function submitClick(){
    var messageText = message.value;
    var time = new Date().getTime();
    if (messageText.length > 0){
        firebase.database().ref('messages/' + sender_email + '_' + friend_email).push().set({
            message: messageText,
            image:'',
            video:'',
            lat:'',
            lon:'',
            time: new Date().getTime(),
            user:semail
        });

        firebase.database().ref('messages/' + friend_email + '_' + sender_email).push().set({
            message: messageText,
            image:'',
            video:'',
            lat:'',
            lon:'',
            time: new Date().getTime(),
            user:semail
        });

        firebase.database().ref('notification/' + friend_email + '/' + sender_email).remove();
        firebase.database().ref('notification/' + friend_email + '/' + sender_email).push().set({
            sender_id: sender_id,
            sender: semail,
            senderName: sender_name,
            msg: messageText,
            senderPhoto: sender_photo,
            time: new Date().getTime()
        });

        firebase.database().ref('notification2/' + friend_email + '/' + sender_email).remove();
        firebase.database().ref('notification2/' + friend_email + '/' + sender_email).push().set({
            sender_id: sender_id,
            sender: semail,
            senderName: sender_name,
            msg: messageText,
            senderPhoto: sender_photo,
            time: new Date().getTime()
        });

        firebase.database().ref('status/' + friend_email + '_' + sender_email).remove();
        firebase.database().ref('status/' + friend_email + '_' + sender_email).push().set({
            sender: sender_name,
            time: new Date().getTime(),
            online: 'online'
        });
        document.getElementById("message").value = "";

        attachBtn.style.display = 'block';
        submitBtn.style.display = 'none';

        console.log("Status: " + online.innerHTML);
        if (online.innerHTML != "online" && online.innerHTML != "is typing..."){
            console.log("Status: " + online.innerHTML);
            sendPush(document.getElementById("pushform"), messageText);
        }

    }else {
        window.alert("Please write something...");
    }
}

var monthes=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

var starCountRef = firebase.database().ref('messages/' + sender_email + '_' + friend_email);
starCountRef.on('child_added', function(snapshot) {
  var new_post = snapshot.val();
  var mes = new_post.message;
  var image = new_post.image;
  var video = new_post.video;
  var lat = new_post.lat;
  var lng = new_post.lon;

  if (mes.length > 0){
      var time = parseInt(new_post.time);

      var date = new Date(time);

      var seconds = date.getSeconds();
      var minutes = date.getMinutes();
      var hours = date.getHours();
//
      var year = date.getFullYear();
      var month = date.getMonth(); // beware: January = 0; February = 1, etc.
      var day = date.getDate();

      var ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      hours = hours ? hours : 12; // the hour '0' should be '12'
      minutes = minutes < 10 ? '0'+minutes : minutes;
      var timeStr = month + '/' + day + '/' + year + ' ' + hours + ':' + minutes + ' ' + ampm;

      var yearStr = year.toString();

      if(day < 10)
            timeStr = monthes[month] + " 0" + day + ", " + yearStr.substr(2, 2) + "' " + hours + ':' + minutes + ' ' + ampm;
        else
            timeStr = monthes[month] + " " + day + ", " + yearStr.substr(2, 2) + "' " + hours + ':' + minutes + ' ' + ampm;

    //   var oneMinuteMilliseconds = 60000;
    //   var oneHourMilliseconds = 3600000;
    //   var oneDayMilliseconds = 24*3600*1000;
    //   var oneMonthMilliseconds = oneDayMilliseconds*30;
    //   var now = Date.now();

    //   if(now - time < oneMinuteMilliseconds) timeStr = "Just now";
    //   if(oneMinuteMilliseconds <= now - time && now - time < oneHourMilliseconds) timeStr = String(parseInt((now - time)/(60000))) + "m ago";
    //   if(oneHourMilliseconds <= now - time && now - time < oneDayMilliseconds) timeStr = String(parseInt((now - time)/(3600000))) + "h ago";
    //   if(oneDayMilliseconds <= now - time && now - time < oneMonthMilliseconds) timeStr = String(parseInt((now - time)/(24*3600000))) + "d ago";

      var ul = document.getElementById("list");
      if (new_post.user == semail){
           var li = document.createElement("div");
           li.style.color = 'white';
           li.style.fontSize = '16';
           li.style.paddingRight = '15';
           li.style.paddingLeft = '15';
           li.style.paddingTop = '10';
           li.style.paddingBottom = '10';
           li.style.backgroundColor = '#2390f6';
           li.style.borderTopLeftRadius = '20px';
           li.style.borderTopRightRadius = '20px';
           li.style.borderBottomLeftRadius = '20px';
           li.style.borderBottomRightRadius = '0px';
           li.style.maxWidth = "500";
           li.style.display = 'inline-block';
           li.innerHTML = urlify(mes);
           li.style.textAlign = 'left';

           if (video.length > 0){
                if (!mes.includes("Please review the information. If you have questions, you can reply directly to the customer. If you want to accept or decline, please click here.")){
                    li.style.position = 'relative';
                    var mark = document.createElement("img");
                    mark.src = '/static/images/fileicon.png';
                    mark.style.width = '33';
                    mark.style.height = '35';
                    mark.style.position = 'absolute';
                    mark.style.top = '0px';
                    mark.style.left = '-40px';
                    li.appendChild(mark);

                    li.onclick = function(){
                        if (video.length > 0){
                            window.open(video);
                        }
                    }
                }
           }

           var ul2 = document.createElement("div");
           ul2.append(li);

           ul2.style.textAlign = 'right';
           ul.appendChild(ul2);

           var lli = document.createElement("div");
           lli.style.color = 'black';
           lli.style.fontSize = '12';
           lli.style.display = 'inline-block';
           lli.innerHTML = timeStr;
           lli.style.textAlign = 'left';
           var ull2 = document.createElement("div");

           ull2.append(lli);
           ull2.style.textAlign = 'right';

           ul.appendChild(ull2);
      }else {
           var li = document.createElement("div");
           li.style.textAlign = 'left';
           li.style.color = 'black';
           li.style.fontSize = '16';
           li.style.paddingRight = '15';
           li.style.paddingLeft = '15';
           li.style.paddingTop = '10';
           li.style.paddingBottom = '10';
           li.style.backgroundColor = '#e0ccff';
           li.style.borderTopLeftRadius = '0px';
           li.style.borderTopRightRadius = '20px';
           li.style.borderBottomLeftRadius = '20px';
           li.style.borderBottomRightRadius = '20px';
           li.style.maxWidth = "500";
           li.style.display = 'inline-block';
           li.innerHTML = urlify2(mes);

           if (video.length > 0){
                if (!mes.includes("Please review the information. If you have questions, you can reply directly to the customer. If you want to accept or decline, please click here.")){
                    li.style.position = 'relative';
                    var mark = document.createElement("img");
                    mark.src = '/static/images/fileicon.png';
                    mark.style.width = '33';
                    mark.style.height = '35';
                    mark.style.position = 'absolute';
                    mark.style.top = '0px';
                    mark.style.right = '-40px';
                    li.appendChild(mark);
                    li.onclick = function(){
                        if (video.length > 0){
                            window.open(video);
                        }
                    }
                }
           }

           if (mes.includes("Please review the information. If you have questions, you can reply directly to the customer. If you want to accept or decline, please click here.")){
                var index = mes.indexOf("Thanks");
                li.innerHTML = mes.substring(0, index-1) + "\n";

                var accept = document.createElement('a');
                accept.style.textAlign = 'center';
                accept.style.color = 'red';
                accept.style.fontSize = '18';
                accept.style.paddingRight = '10';
                accept.style.paddingLeft = '10';
                accept.style.paddingTop = '10';
                accept.style.paddingBottom = '10';
                accept.style.backgroundColor = '#e0d0f6';
                accept.style.display = 'inline-block';

                accept.setAttribute('href',"javascript:accept('accepted', lat, lng, video);");
                accept.innerHTML = "Accept";

                li.appendChild(accept);

                accept.onclick = function(){
                   send_msg('accepted', lat, lng, video);
                }

                var decline = document.createElement("a");
                decline.style.textAlign = 'center';
                decline.style.color = 'red';
                decline.style.fontSize = '18';
                decline.style.paddingRight = '10';
                decline.style.paddingLeft = '10';
                decline.style.paddingTop = '10';
                decline.style.paddingBottom = '10';
                decline.style.backgroundColor = '#e0d0f6';
                decline.style.display = 'inline-block';
                decline.style.marginLeft = "50";
                decline.setAttribute('href',"javascript:accept('declined', lat, lng, video);");
                decline.innerHTML = "Decline";
                li.appendChild(decline);

                decline.onclick = function(){
                   send_msg('declined', lat, lng, video);
                }

                var footer = document.createElement("div");
                footer.style.textAlign = 'left';
                footer.style.color = 'black';
                footer.style.fontSize = '16';
                footer.style.paddingRight = '10';
                footer.style.paddingLeft = '10';
                footer.style.paddingTop = '10';
                footer.style.paddingBottom = '10';
                footer.style.backgroundColor = '#e0d0f6';
                footer.style.maxWidth = "300";
                footer.style.display = 'inline-block';
                footer.innerHTML = mes.substring(index, mes.length);
                li.appendChild(footer);
           }

           var ul3 = document.createElement("div");
           ul3.append(li);

           ul.appendChild(ul3);

           var llli = document.createElement("div");
           llli.style.textAlign = 'left';
           llli.style.color = 'black';
           llli.style.fontSize = '12';

           llli.style.display = 'inline-block';
           llli.innerHTML = timeStr;
           var ull3 = document.createElement("div");

           ull3.append(llli);
           ul.appendChild(ull3);
      }

      chat_log.scrollTop = chat_log.scrollHeight;
  }
  if(image.length > 0){
      var time = parseInt(new_post.time);

      var date = new Date(time);

      var seconds = date.getSeconds();
      var minutes = date.getMinutes();
      var hours = date.getHours();
//
      var year = date.getFullYear();
      var month = date.getMonth(); // beware: January = 0; February = 1, etc.
      var day = date.getDate();

      var ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      hours = hours ? hours : 12; // the hour '0' should be '12'
      minutes = minutes < 10 ? '0'+minutes : minutes;
      var timeStr = month + '/' + day + '/' + year + ' ' + hours + ':' + minutes + ' ' + ampm;

      var yearStr = year.toString();

      if(day < 10)
            timeStr = monthes[month] + " 0" + day + ", " + yearStr.substr(2, 2) + "' " + hours + ':' + minutes + ' ' + ampm;
        else
            timeStr = monthes[month] + " " + day + ", " + yearStr.substr(2, 2) + "' " + hours + ':' + minutes + ' ' + ampm;

    //   var oneMinuteMilliseconds = 60000;
    //   var oneHourMilliseconds = 3600000;
    //   var oneDayMilliseconds = 24*3600*1000;
    //   var oneMonthMilliseconds = oneDayMilliseconds*30;
    //   var now = Date.now();

    //   if(now - time < oneMinuteMilliseconds) timeStr = "Just now";
    //   if(oneMinuteMilliseconds <= now - time && now - time < oneHourMilliseconds) timeStr = String(parseInt((now - time)/(60000))) + "m ago";
    //   if(oneHourMilliseconds <= now - time && now - time < oneDayMilliseconds) timeStr = String(parseInt((now - time)/(3600000))) + "h ago";
    //   if(oneDayMilliseconds <= now - time && now - time < oneMonthMilliseconds) timeStr = String(parseInt((now - time)/(24*3600000))) + "d ago";

      var ul = document.getElementById("list");
      if (new_post.user == semail){

           var img = document.createElement("img");

           img.style.width = "200";
           img.style.height = "auto";
           img.style.maxHeight = "200";
           img.style.borderTopLeftRadius = '10px';
           img.style.borderTopRightRadius = '10px';
           img.style.borderBottomLeftRadius = '10px';
           img.style.borderBottomRightRadius = '0px';
           img.style.display = 'inline-block';
           if(image.length > 1500)img.src = "data:image/jpeg;base64,"+image;
           else img.src = image;
           img.classList.add("cropping");

           var li = document.createElement("div");

           li.style.paddingRight = '10';
           li.style.paddingLeft = '10';
           li.style.paddingTop = '10';
           li.style.paddingBottom = '10';
           li.style.backgroundColor = '#2390f6';
           li.style.borderTopLeftRadius = '20px';
           li.style.borderTopRightRadius = '20px';
           li.style.borderBottomLeftRadius = '20px';
           li.style.borderBottomRightRadius = '0px';
           li.style.maxWidth = "300";
           li.style.display = 'inline-block';
           li.appendChild(img);

           if (video.length > 0){
                li.style.position = 'relative';
                var mark = document.createElement("img");
                mark.src = '/static/images/playbutton.png';
                mark.style.width = '40';
                mark.style.height = '30';
                mark.style.position = 'absolute';
                mark.style.top = '40%';
                mark.style.right = '40%';
                li.appendChild(mark);
           }

           li.onclick = function(){
              if (video.length > 0){
                  window.open(video, '_blank');
              }else{
                  if (lat.length > 0){
                      window.location.href = "/show_chatloc?latlng=" + String(lat) + "_" + String(lng);
                  }
                  else{
                      window.open(image, '_blank');
                  }
              }
           }

           var ul2 = document.createElement("div");

           ul2.append(li);
           ul2.style.textAlign = 'right';
           ul.appendChild(ul2);

           var lli = document.createElement("div");
           lli.style.color = 'black';
           lli.style.fontSize = '12';
           lli.style.display = 'inline-block';
           lli.innerHTML = timeStr;
           lli.style.textAlign = 'left';
           var ull2 = document.createElement("div");

           ull2.append(lli);
           ull2.style.textAlign = 'right';

           ul.appendChild(ull2);
      }else {

           var img = document.createElement("img");

           img.style.width = "200";
           img.style.height = "auto";
           img.style.maxHeight = "200";
           img.style.borderTopLeftRadius = '0px';
           img.style.borderTopRightRadius = '10px';
           img.style.borderBottomLeftRadius = '10px';
           img.style.borderBottomRightRadius = '10px';
           img.style.display = 'inline-block';
           if(image.length > 1500)img.src = "data:image/jpeg;base64,"+image;
           else img.src = image;
           img.classList.add("cropping");

           var li = document.createElement("div");

           li.style.paddingRight = '10';
           li.style.paddingLeft = '10';
           li.style.paddingTop = '10';
           li.style.paddingBottom = '10';
           li.style.backgroundColor = '#e0ccff';
           li.style.borderTopLeftRadius = '0px';
           li.style.borderTopRightRadius = '20px';
           li.style.borderBottomLeftRadius = '20px';
           li.style.borderBottomRightRadius = '20px';
           li.style.maxWidth = "300";
           li.style.display = 'inline-block';
           li.appendChild(img);

           if (video.length > 0){
                li.style.position = 'relative';
                var mark = document.createElement("img");
                mark.src = '/static/images/playbutton.png';
                mark.style.width = '40';
                mark.style.height = '30';
                mark.style.position = 'absolute';
                mark.style.top = '40%';
                mark.style.right = '40%';
                li.appendChild(mark);
           }

           li.onclick = function(){
              if (video.length > 0){
                   window.open(video, '_blank');
              }else{
                  if (lat.length > 0){
                      window.location.href = "/show_chatloc?latlng=" + String(lat) + "_" + String(lng);
                  }
                  else{
                      window.open(image, '_blank');
                  }
              }
           }

           var ul3 = document.createElement("div");

           ul3.append(li);
           ul.appendChild(ul3);

           var llli = document.createElement("div");
           llli.style.textAlign = 'left';
           llli.style.color = 'black';
           llli.style.fontSize = '12';

           llli.style.display = 'inline-block';
           llli.innerHTML = timeStr;
           var ull3 = document.createElement("div");

           ull3.append(llli);
           ul.appendChild(ull3);
      }

      chat_log.scrollTop = chat_log.scrollHeight;
  }

  chat_log.scrollTop = chat_log.scrollHeight;

});


var starCountRef = firebase.database().ref('status/' + sender_email + '_' + friend_email);
starCountRef.on('child_added', function(snapshot) {
    var new_status = snapshot.val();
    var onoff = new_status.online;
    if (onoff == 'offline'){
        var time = parseInt(new_status.time);
        var date = new Date(time);

        var seconds = date.getSeconds();
        var minutes = date.getMinutes();
        var hours = date.getHours();

        var year = date.getFullYear();
        var month = date.getMonth(); // beware: January = 0; February = 1, etc.
        var day = date.getDate();

        var ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12; // the hour '0' should be '12'
        minutes = minutes < 10 ? '0'+minutes : minutes;
        var timeStr = month + '/' + day + '/' + year + ' ' + hours + ':' + minutes + ' ' + ampm;

        var yearStr = year.toString();

          if(day < 10)
                timeStr = monthes[month] + " 0" + day + ", " + yearStr.substr(2, 2) + "' " + hours + ':' + minutes + ' ' + ampm;
            else
                timeStr = monthes[month] + " " + day + ", " + yearStr.substr(2, 2) + "' " + hours + ':' + minutes + ' ' + ampm;

        //   var oneMinuteMilliseconds = 60000;
        //   var oneHourMilliseconds = 3600000;
        //   var oneDayMilliseconds = 24*3600*1000;
        //   var oneMonthMilliseconds = oneDayMilliseconds*30;
        //   var now = Date.now();

        //   if(now - time < oneMinuteMilliseconds) timeStr = "Just now";
        //   if(oneMinuteMilliseconds <= now - time && now - time < oneHourMilliseconds) timeStr = String(parseInt((now - time)/(60000))) + "m ago";
        //   if(oneHourMilliseconds <= now - time && now - time < oneDayMilliseconds) timeStr = String(parseInt((now - time)/(3600000))) + "h ago";
        //   if(oneDayMilliseconds <= now - time && now - time < oneMonthMilliseconds) timeStr = String(parseInt((now - time)/(24*3600000))) + "d ago";

        online.innerHTML = 'Last seen at ' + timeStr;
        st.innerHTML = 'Offline';
        st.style.display = 'inline-block';
    }else {
        online.innerHTML = onoff;
        st.innerHTML = onoff;
        st.style.display = 'inline-block';
    }
});


function urlify(text) {
    var urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, function(url) {
        return '<a href="' + url + '" style="color:yellow; word-break: break-all;">' + url + '</a>';
    })
}

function urlify2(text) {
    var urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, function(url) {
        return '<a href="' + url + '" style="color:red; word-break: break-all;">' + url + '</a>';
    })
}


//window.onload = function () {
//    if (typeof history.pushState === "function") {
//        history.pushState("jibberish", null, null);
//        window.onpopstate = function () {
//            if (confirm("Do you want to exit the room?")) {
//                firebase.database().ref('status/' + user_id + '_' + sender_id).remove();
//                firebase.database().ref('status/' + user_id + '_' + sender_id).push().set({
//                    sender: sender_name,
//                    time: new Date().getTime(),
//                    online: 'offline'
//                });
//                history.go(-1);
//            }
//        };
//
//    }
//};


function myFunction() {

    if(message.value.length > 0){
        firebase.database().ref('status/' + friend_email + '_' + sender_email).remove();
        firebase.database().ref('status/' + friend_email + '_' + sender_email).push().set({
            user: semail,
            time: new Date().getTime(),
            online: 'is typing...'
        });
    }else {
        firebase.database().ref('status/' + friend_email + '_' + sender_email).remove();
        firebase.database().ref('status/' + friend_email + '_' + sender_email).push().set({
            user: semail,
            time: new Date().getTime(),
            online: 'online'
        });
    }

    isTyping();
}


function isTyping(){

    if(message.value.length > 0){
        attachBtn.style.display = 'none';
        submitBtn.style.display = 'block';
    }else{
        attachBtn.style.display = 'block';
        submitBtn.style.display = 'none';
    }

    // alert('is typing...');

}



function okay(){
   var type = document.getElementById("type").value;
   var image = getBase64Image(document.getElementById("image_message"));
   var time = new Date().getTime();
   if (type == 'picture'){

       var progressBar = document.getElementById('gif');

        progressBar.style.display = 'block';
        document.getElementById("imageFrame").style.display = "none";

        var storageRef = firebase.storage().ref();

        var uploadTask = storageRef.child(file.name).put(file);
        uploadTask.on('state_changed', function(snapshot){
            // Observe state change events such as progress, pause, and resume
            // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
            var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            console.log('Upload is ' + progress + '% done');
            switch (snapshot.state) {
                case firebase.storage.TaskState.PAUSED: // or 'paused'
                    console.log('Upload is paused');
                    break;
                case firebase.storage.TaskState.RUNNING: // or 'running'
                    console.log('Upload is running');
                    break;
            }
        }, function(error) {
            // Handle unsuccessful uploads
        }, function() {
            // Handle successful uploads on complete
            // For instance, get the download URL: https://firebasestorage.googleapis.com/...
            var downloadURL = uploadTask.snapshot.downloadURL;

            if (image.length > 0){
                firebase.database().ref('messages/' + sender_email + '_' + friend_email).push().set({
                    message: '',
                    image: String(downloadURL),
                    video:'',
                    lat:'',
                    lon:'',
                    time: new Date().getTime(),
                    user:semail
                });
                firebase.database().ref('messages/' + friend_email + '_' + sender_email).push().set({
                    message: '',
                    image: String(downloadURL),
                    video:'',
                    lat:'',
                    lon:'',
                    time: new Date().getTime(),
                    user:semail
                });
                firebase.database().ref('notification/' + friend_email + '/' + sender_email).remove();
                firebase.database().ref('notification/' + friend_email + '/' + sender_email).push().set({
                    sender_id: sender_id,
                    sender: semail,
                    senderName: sender_name,
                    msg: 'Shared a file',
                    senderPhoto: sender_photo,
                    time: new Date().getTime()
                });
                firebase.database().ref('notification2/' + friend_email + '/' + sender_email).remove();
                firebase.database().ref('notification2/' + friend_email + '/' + sender_email).push().set({
                    sender_id: sender_id,
                    sender: semail,
                    senderName: sender_name,
                    msg: 'Shared a file',
                    senderPhoto: sender_photo,
                    time: new Date().getTime()
                });
                firebase.database().ref('status/' + friend_email + '_' + sender_email).remove();
                firebase.database().ref('status/' + friend_email + '_' + sender_email).push().set({
                    sender: sender_name,
                    time: new Date().getTime(),
                    online: 'online'
                });

                progressBar.style.display = 'none';

                console.log("Status: " + online.innerHTML);
                if (online.innerHTML != "online" && online.innerHTML != "is typing..."){
                    console.log("Status: " + online.innerHTML);
                    sendPush(document.getElementById("pushform"), 'Shared a picture');
                }

            }
        });
   }
   else if (type == 'video'){

        const fileSize = file.size / 1024 / 1024; // in MiB
        if (fileSize > 10) {
            showFailureAlert("Your file can not exceed 10MB. Please upload another file.");
            return;
        }

//        var storageRef = firebase.storage().ref(file.name);
//        storageRef.put(file);
        var progressBar = document.getElementById('gif');

        progressBar.style.display = 'block';
        document.getElementById("imageFrame").style.display = "none";

        var thumbnail = getThumbImage(document.getElementById('videoresult'));

        var storageRef = firebase.storage().ref();

        var uploadTask = storageRef.child(file.name).put(file);
        uploadTask.on('state_changed', function(snapshot){
            // Observe state change events such as progress, pause, and resume
            // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
            var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            console.log('Upload is ' + progress + '% done');
            switch (snapshot.state) {
                case firebase.storage.TaskState.PAUSED: // or 'paused'
                    console.log('Upload is paused');
                    break;
                case firebase.storage.TaskState.RUNNING: // or 'running'
                    console.log('Upload is running');
                    break;
            }
        }, function(error) {
            // Handle unsuccessful uploads
        }, function() {
            // Handle successful uploads on complete
            // For instance, get the download URL: https://firebasestorage.googleapis.com/...
            var downloadURL = uploadTask.snapshot.downloadURL;

            firebase.database().ref('messages/' + sender_email + '_' + friend_email).push().set({
                message: '',
                image: thumbnail,
                video: String(downloadURL),
                lat:'',
                lon:'',
                time: new Date().getTime(),
                user:semail
            });
            firebase.database().ref('messages/' + friend_email + '_' + sender_email).push().set({
                message: '',
                image: thumbnail,
                video: String(downloadURL),
                lat:'',
                lon:'',
                time: new Date().getTime(),
                user:semail
            });
            firebase.database().ref('notification/' + friend_email + '/' + sender_email).remove();
            firebase.database().ref('notification/' + friend_email + '/' + sender_email).push().set({
                sender_id: sender_id,
                sender: semail,
                senderName: sender_name,
                msg: 'Shared a file',
                senderPhoto: sender_photo,
                time: new Date().getTime()
            });
            firebase.database().ref('notification2/' + friend_email + '/' + sender_email).remove();
            firebase.database().ref('notification2/' + friend_email + '/' + sender_email).push().set({
                sender_id: sender_id,
                sender: semail,
                senderName: sender_name,
                msg: 'Shared a file',
                senderPhoto: sender_photo,
                time: new Date().getTime()
            });
            firebase.database().ref('status/' + friend_email + '_' + sender_email).remove();
            firebase.database().ref('status/' + friend_email + '_' + sender_email).push().set({
                sender: sender_name,
                time: new Date().getTime(),
                online: 'online'
            });

            progressBar.style.display = 'none';

            console.log("Status: " + online.innerHTML);
            if (online.innerHTML != "online" && online.innerHTML != "is typing..."){
                console.log("Status: " + online.innerHTML);
                sendPush(document.getElementById("pushform"), 'Shared a video');
            }


        });
   }
   else if (type == 'map'){
        var lat = document.getElementById("lat").value;
        var lng = document.getElementById("lng").value;
        var image = getBase64Image(document.getElementById("image_message"));
        if (image.length > 0){
            firebase.database().ref('messages/' + sender_email + '_' + friend_email).push().set({
                message: '',
                image: image,
                video:'',
                lat:lat,
                lon:lng,
                time: new Date().getTime(),
                user:semail
            });
            firebase.database().ref('messages/' + friend_email + '_' + sender_email).push().set({
                message: '',
                image: image,
                video:'',
                lat:lat,
                lon:lng,
                time: new Date().getTime(),
                user:semail
            });
            firebase.database().ref('notification/' + friend_email + '/' + sender_email).remove();
            firebase.database().ref('notification/' + friend_email + '/' + sender_email).push().set({
                sender_id: sender_id,
                sender: semail,
                senderName: sender_name,
                msg: 'Shared a location',
                senderPhoto: sender_photo,
                time: new Date().getTime()
            });
            firebase.database().ref('notification2/' + friend_email + '/' + sender_email).remove();
            firebase.database().ref('notification2/' + friend_email + '/' + sender_email).push().set({
                sender_id: sender_id,
                sender: semail,
                senderName: sender_name,
                msg: 'Shared a location',
                senderPhoto: sender_photo,
                time: new Date().getTime()
            });
            firebase.database().ref('status/' + friend_email + '_' + sender_email).remove();
            firebase.database().ref('status/' + friend_email + '_' + sender_email).push().set({
                sender: sender_name,
                time: new Date().getTime(),
                online: 'online'
            });
            document.getElementById("imageFrame").style.display = "none";

            console.log("Status: " + online.innerHTML);
            if (online.innerHTML != "online" && online.innerHTML != "is typing..."){
                console.log("Status: " + online.innerHTML);
                sendPush(document.getElementById("pushform"), 'Shared a location');
            }

        }
   }
}

function getBase64Image(img) {
  var canvas = document.createElement("canvas");
  canvas.width = img.width;
  canvas.height = img.height;
  var ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  var dataURL = canvas.toDataURL("image/png");
  return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
}

function getThumbImage(video) {
  var canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  var ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  var dataURL = canvas.toDataURL("image/png");
  return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
}


function uploadFile(file){

        var progressBar = document.getElementById('gif');
        progressBar.style.display = 'block';

        var storageRef = firebase.storage().ref();

        var uploadTask = storageRef.child(file.name).put(file);
        uploadTask.on('state_changed', function(snapshot){
            // Observe state change events such as progress, pause, and resume
            // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
            var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            console.log('Upload is ' + progress + '% done');
            switch (snapshot.state) {
                case firebase.storage.TaskState.PAUSED: // or 'paused'
                    console.log('Upload is paused');
                    break;
                case firebase.storage.TaskState.RUNNING: // or 'running'
                    console.log('Upload is running');
                    break;
            }
        }, function(error) {
            // Handle unsuccessful uploads
        }, function() {
            // Handle successful uploads on complete
            // For instance, get the download URL: https://firebasestorage.googleapis.com/...
            var downloadURL = uploadTask.snapshot.downloadURL;

            firebase.database().ref('messages/' + sender_email + '_' + friend_email).push().set({
                message: 'Sent a file: ' + file.name,
                image: '',
                video: String(downloadURL),
                lat:'',
                lon:'',
                time: new Date().getTime(),
                user:semail
            });
            firebase.database().ref('messages/' + friend_email + '_' + sender_email).push().set({
                message: 'Sent a file: ' + file.name,
                image: '',
                video: String(downloadURL),
                lat:'',
                lon:'',
                time: new Date().getTime(),
                user:semail
            });
            firebase.database().ref('notification/' + friend_email + '/' + sender_email).remove();
            firebase.database().ref('notification/' + friend_email + '/' + sender_email).push().set({
                sender_id: sender_id,
                sender: semail,
                senderName: sender_name,
                msg: 'Shared a file',
                senderPhoto: sender_photo,
                time: new Date().getTime()
            });
            firebase.database().ref('notification2/' + friend_email + '/' + sender_email).remove();
            firebase.database().ref('notification2/' + friend_email + '/' + sender_email).push().set({
                sender_id: sender_id,
                sender: semail,
                senderName: sender_name,
                msg: 'Shared a file',
                senderPhoto: sender_photo,
                time: new Date().getTime()
            });
            firebase.database().ref('status/' + friend_email + '_' + sender_email).remove();
            firebase.database().ref('status/' + friend_email + '_' + sender_email).push().set({
                sender: sender_name,
                time: new Date().getTime(),
                online: 'online'
            });

            progressBar.style.display = 'none';

            console.log("Status: " + online.innerHTML);
            if (online.innerHTML != "online" && online.innerHTML != "is typing..."){
                console.log("Status: " + online.innerHTML);
                sendPush(document.getElementById("pushform"), 'Shared a file');
            }

        });
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function accept(sts, lat, lng, mailid){
 //   alert(sts);
}

function post(path, params, method) {
    method = method || "post"; // Set method to post by default if not specified.

    // The rest of this code assumes you are not using a library.
    // It can be made less wordy if you use one.
    var form = document.createElement("form");
    form.setAttribute("method", method);
    form.setAttribute("action", path);

    for(var key in params) {
        if(params.hasOwnProperty(key)) {
            var hiddenField = document.createElement("input");
            hiddenField.setAttribute("type", "hidden");
            hiddenField.setAttribute("name", key);
            hiddenField.setAttribute("value", params[key]);

            form.appendChild(hiddenField);
        }
    }

    document.body.appendChild(form);
    form.submit();
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

var date = new Date();
var time = new Date().getTime();
var seconds = date.getSeconds();
var minutes = date.getMinutes();
var hours = date.getHours();
//
var year = date.getFullYear();
var month = date.getMonth(); // beware: January = 0; February = 1, etc.
var day = date.getDate();

var ampm = hours >= 12 ? 'PM' : 'AM';
hours = hours % 12;
hours = hours ? hours : 12; // the hour '0' should be '12'
minutes = minutes < 10 ? '0'+minutes : minutes;
var timeStr = month + '/' + day + '/' + year + ' ' + hours + ':' + minutes + ' ' + ampm;


      var yearStr = year.toString();

      if(day < 10)
            timeStr = monthes[month] + " 0" + day + ", " + yearStr.substr(2, 2) + "' " + hours + ':' + minutes + ' ' + ampm;
        else
            timeStr = monthes[month] + " " + day + ", " + yearStr.substr(2, 2) + "' " + hours + ':' + minutes + ' ' + ampm;

    //   var oneMinuteMilliseconds = 60000;
    //   var oneHourMilliseconds = 3600000;
    //   var oneDayMilliseconds = 24*3600*1000;
    //   var oneMonthMilliseconds = oneDayMilliseconds*30;
    //   var now = Date.now();

    //   if(now - time < oneMinuteMilliseconds) timeStr = "Just now";
    //   if(oneMinuteMilliseconds <= now - time && now - time < oneHourMilliseconds) timeStr = String(parseInt((now - time)/(60000))) + "m ago";
    //   if(oneHourMilliseconds <= now - time && now - time < oneDayMilliseconds) timeStr = String(parseInt((now - time)/(3600000))) + "h ago";
    //   if(oneDayMilliseconds <= now - time && now - time < oneMonthMilliseconds) timeStr = String(parseInt((now - time)/(24*3600000))) + "d ago";



var datetime = timeStr;

function send_msg(sts, lat, lng, video){
    var messageText = '';
    if (sts == 'accepted'){
        messageText = 'Hi, ' + friend_name + '\n' + sender_name + ' has accepted you ' +
            lat + ' with schedule of ' + lng + '\n' + 'Thanks\n' + datetime + '\n' + sender_name;
    }else if (sts == 'declined'){
        messageText = 'Hi, ' + friend_name + '\n' + sender_name + ' can\'t do you ' + lat + ' with your requested schedule of ' +
            lng + '\n' + 'Please select another time or another service provider.\n' + 'We apologize for the inconvenience\n' + datetime + '\n' + sender_name;
    }

    if (messageText.length > 0){
        firebase.database().ref('messages/' + sender_email + '_' + friend_email).push().set({
            message: messageText,
            image:'',
            video:'',
            lat: '',
            lon: '',
            time: new Date().getTime(),
            user:semail
        });
        firebase.database().ref('messages/' + friend_email + '_' + sender_email).push().set({
            message: messageText,
            image:'',
            video:'',
            lat: '',
            lon: '',
            time: new Date().getTime(),
            user:semail
        });
        firebase.database().ref('notification/' + friend_email + '/' + sender_email).remove();
        firebase.database().ref('notification/' + friend_email + '/' + sender_email).push().set({
            sender_id: sender_id,
            sender: semail,
            senderName: sender_name,
            msg: messageText,
            senderPhoto: sender_photo,
            time: new Date().getTime()
        });
        firebase.database().ref('notification2/' + friend_email + '/' + sender_email).remove();
        firebase.database().ref('notification2/' + friend_email + '/' + sender_email).push().set({
            sender_id: sender_id,
            sender: semail,
            senderName: sender_name,
            msg: messageText,
            senderPhoto: sender_photo,
            time: new Date().getTime()
        });
    }
}

</script>


<form id="pushform" action="/mothers/pushsend" method="POST" enctype="multipart/form-data" style="display:none;">
    {% csrf_token %}
    <input hidden name="receiver_id" value="{{friend.pk}}">
    <input hidden name="sender_id" value="{{me.pk}}">
    <input hidden name="message" id="chatmes" value="">
</form>

<script>

function sendPush(form, message){
    document.getElementById("chatmes").value = message;
    var formData = new FormData(form);
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            console.log('Result: ' + xhr.response)
        }
    };
    xhr.open('POST', form.getAttribute('action'), true);
    xhr.send(formData);
}

function showSuccessAlert(msg) {
    swal({
        title: "Success!",
        text: msg,
        icon: "success",
        button: "OK",
    });
}

function showFailureAlert(msg) {
    swal({
        title: "Oops! We ran into an issue.",
        text: msg,
        icon: "warning",
        button: "OK",
        dangerMode: true,
    });
}

</script>


</body>

</html>




























































